$NetBSD: patch-aa,v 1.12 2000/10/15 14:17:14 itojun Exp $

--- configure.in.orig	Thu Aug 31 07:20:05 2000
+++ configure.in	Thu Oct 12 09:23:08 2000
@@ -337,2 +337,3 @@
 saved_CFLAGS="$CFLAGS"
+crypto_LIBS=""
 if test "x$prefix" != "xNONE" ; then
@@ -353,8 +354,21 @@
 
-		LIBS="$saved_LIBS -lcrypto"
-
-		# Basic test to check for compatible version and correct linking
-		# *does not* test for RSA - that comes later.
-		AC_TRY_RUN(
-			[
+		# Some ELF systems can't resolve all the symbols in libcrypto
+		# if libcrypto was linked against RSAREF, and fail to link the
+		# test program correctly, even though a correct installation
+		# of OpenSSL exists.  So we test the linking three times in
+		# case the RSAREF libraries are needed right away.  We'll test
+		# for them explicitly later on.
+		#
+		for libcrypto in \
+			"-lcrypto" \
+			"-lcrypto -lrsaref" \
+			"-lcrypto -lRSAglue -lrsaref"
+		do
+			LIBS="$saved_LIBS $libcrypto"
+
+			# Basic test to check for compatible version and
+			# correct linking *does not* test for RSA - that comes
+			# later.
+			AC_TRY_RUN(
+				[
 #include <string.h>
@@ -368,8 +382,10 @@
 }
-			],
-			[
-				found_crypto=1
-				break;
-			], []
-		)
+				],
+				[
+					found_crypto=1
+					crypto_LIBS=$libcrypto
+					break;
+				], []
+			)
+		done
 
@@ -403,3 +419,3 @@
 fi
-LIBS="$saved_LIBS -lcrypto"
+LIBS="$saved_LIBS $crypto_LIBS"
 
@@ -764,3 +780,3 @@
 		],
-		[ struct passwd p s; p.pw_class = NULL; ],
+		[ struct passwd p; p.pw_class = NULL; ],
 		[ ac_cv_have_pw_class_in_struct_passwd="yes" ],
