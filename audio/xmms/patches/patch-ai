$NetBSD: patch-ai,v 1.3 2001/05/20 20:52:24 rh Exp $

--- xmms/main.c.orig	Mon Nov 20 16:45:10 2000
+++ xmms/main.c
@@ -35,6 +35,23 @@
 #include "libxmms/dirbrowser.h"
 #include "xmms_mini.xpm"
 
+#ifdef __NetBSD__
+#include <gtk/gtk.h>
+#include <pthread.h>
+
+/*
+ * NetBSD uses non-preemptive pth, so we yield the processor periodically
+ */
+
+gint
+pth_nbschedule (gpointer data)
+{
+	pthread_yield_np();
+
+	return TRUE;
+}
+#endif
+
 GtkWidget *mainwin, *mainwin_url_window = NULL, *mainwin_dir_browser = NULL;
 GtkWidget *mainwin_jtt = NULL, *mainwin_jtf = NULL;
 GtkItemFactory *mainwin_options_menu, *mainwin_songname_menu, *mainwin_vis_menu;
@@ -3232,7 +3249,7 @@
 	gchar *filename;
 	gint i;
 	gboolean have_display = FALSE;
-#ifdef HAVE_SCHED_SETSCHEDULER
+#if defined(HAVE_SCHED_SETSCHEDULER) && !defined(__NetBSD__)
 	struct sched_param sparam;
 
 #endif
@@ -3283,7 +3300,7 @@
 
 	if (geteuid() == 0)
 	{
-#ifdef HAVE_SCHED_SETSCHEDULER
+#if defined(HAVE_SCHED_SETSCHEDULER) && !defined(__NetBSD__)
 		if (cfg.use_realtime)
 		{
 			sparam.sched_priority = sched_get_priority_max(SCHED_RR);
@@ -3401,6 +3418,11 @@
 
 	/* enable_x11r5_session_management(argc, argv); */
 	sm_init(argc, argv);
+
+#ifdef __NetBSD__
+	gtk_timeout_add (150, pth_nbschedule, NULL);
+#endif
+
 	gtk_main();
 
 	return 0;
