$NetBSD: patch-ac,v 1.3 1999/06/02 16:14:53 christos Exp $

--- dialects/n+obsd/dproc.c.orig	Sun May  9 15:56:13 1999
+++ dialects/n+obsd/dproc.c	Mon May  3 12:03:10 1999
@@ -150,6 +150,9 @@
 gather_proc_info()
 {
 	struct filedesc fd;
+#if __NetBSD_Version__ >= 104010000
+	struct cwdinfo cwdi;
+#endif
 	int i, nf;
 	MALLOC_S nb;
 	static struct file **ofb = NULL;
@@ -215,23 +218,53 @@
 		(UID_ARG)uid, p->P_COMM, (int)pss, (int)sf);
 	    Plf = (struct lfile *)NULL;
 	    Kpa = (KA_T)p->P_ADDR;
+#if __NetBSD_Version__ >= 104010000
+	/*
+	 * Save current working directory framework information.
+	 */
+	    (void)memset(&cwdi, 0, sizeof(cwdi));
+	    if (p->kp_proc.p_cwdi) {
+	        if (kvm_read(Kd, (u_long)p->kp_proc.p_cwdi, &cwdi, sizeof(cwdi))
+	            != sizeof(cwdi)) {
+	                fprintf(stderr, "%s: cannot read cwdinfo: %s\n", Pn,
+			    kvm_geterr(Kd));
+			Exit(1);
+		}
+	    }
+#endif
 	/*
 	 * Save current working directory information.
 	 */
+#if __NetBSD_Version__ >= 104010000
+	    if (cwdi.cwdi_cdir) {
+#else
 	    if (fd.fd_cdir) {
+#endif
 		alloc_lfile(CWD, -1);
 		Cfp = (struct file *)NULL;
+#if __NetBSD_Version__ >= 104010000
+		process_node((KA_T)cwdi.cwdi_cdir);
+#else
 		process_node((KA_T)fd.fd_cdir);
+#endif
 		if (Lf->sf)
 		    link_lfile();
 	    }
 	/*
 	 * Save root directory information.
 	 */
+#if __NetBSD_Version__ >= 104010000
+	    if (cwdi.cwdi_rdir) {
+#else
 	    if (fd.fd_rdir) {
+#endif
 		alloc_lfile(RTD, -1);
 		Cfp = (struct file *)NULL;
+#if __NetBSD_Version__ >= 104010000
+		process_node((KA_T)cwdi.cwdi_rdir);
+#else
 		process_node((KA_T)fd.fd_rdir);
+#endif
 		if (Lf->sf)
 		    link_lfile();
 	    }
@@ -422,11 +455,11 @@
 	int i, j;
 	KA_T ka;
 	int n = 0;
-	struct pager_struct pg;
 	struct vm_map_entry vmme, *e;
 	struct vmspace vmsp;
 
 #if	!defined(UVM)
+	struct pager_struct pg;
 	struct vm_object vmo;
 #endif	/* !defined(UVM) */
 
