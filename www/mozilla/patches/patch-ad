$NetBSD: patch-ad,v 1.7 2000/06/19 04:17:27 soren Exp $

--- configure.in.orig	Tue Jun 13 16:56:51 2000
+++ configure.in	Mon Jun 19 06:06:55 2000
@@ -344,6 +344,11 @@
 TARGET_MD_ARCH=unix
 DIRENT_INO=d_ino
 NEED_BASE_DLL_NAME_ALSO=
+SHLIB_MAJOR=
+SHLIB_MINOR=
+OBJECT_FMT=
+SHLIB_LDSTARTFILE=
+SHLIB_LDENDFILE=
 
 MOZ_JPEG_CFLAGS=
 MOZ_JPEG_LIBS='-L$(DIST)/lib -ljpeg'
@@ -682,29 +687,28 @@
     ;;
 
 *-netbsd*)
-    DLL_SUFFIX=".so.1.0"
+   SHLIB_MAJOR=1
+   SHLIB_MINOR=0
     DSO_CFLAGS=''
-    DSO_PIC_CFLAGS='-fPIC'
     CFLAGS="$CFLAGS -Dunix"
     CXXFLAGS="$CXXFLAGS -Dunix"
+    if $CC -E - -dM </dev/null | grep __ELF__ >/dev/null; then
+        DLL_SUFFIX=".so"
+        LIBRUNPATH='`(cd $(DIST)/bin; /bin/pwd)`'
+        DSO_PIC_CFLAGS='-fpic -DPIC'
+        DSO_LDOPTS='-x -shared -soname lib$(LIBRARY_NAME).so.$(SHLIB_MAJOR)'
+        OBJECT_FMT=ELF
+        SHLIB_LDSTARTFILE=/usr/lib/crtbeginS.o
+        SHLIB_LDENDFILE=/usr/lib/crtendS.o
+    else
+    	DSO_PIC_CFLAGS='-fpic -DPIC'
+    	DLL_SUFFIX=".so.${SHLIB_MAJOR}.${SHLIB_MINOR}"
+    	DSO_LDOPTS='-x -shared'
+    	SHLIB_LDSTARTFILE=/usr/lib/c++rt0.o
+    fi
     # At least for 1.3 and up, ld supports this, despite the test failing above.
     MKSHLIB_FORCE_ALL='--whole-archive'
     MKSHLIB_UNFORCE_ALL='--no-whole-archive'
-    case $OS_TEST in
-	alpha)
-		dnl NetBSD/alpha can't find a shared lib
-		dnl (.so.1.0) unless there's a .so as well.
-		NEED_BASE_DLL_NAME_ALSO=1
-		;;
-	*86)
-		MKSHLIB='$(LD) $(DSO_LDOPTS) -o $@'
-		MKCSHLIB='$(LD) $(DSO_LDOPTS) -o $@'
-		;;
-    esac
-    dnl Test for a.out platform and handle C++ libraries correctly
-    if $CC -E - -dM </dev/null | grep -v __ELF__ >/dev/null; then
-	DSO_LDOPTS="-shared"
-    fi
     if test "$LIBRUNPATH"; then
 	DSO_LDOPTS="-R$LIBRUNPATH $DSO_LDOPTS"
     fi
@@ -947,6 +951,11 @@
 
 dnl See above (netbsd)
 AC_SUBST(NEED_BASE_DLL_NAME_ALSO)
+AC_SUBST(SHLIB_MAJOR)
+AC_SUBST(SHLIB_MINOR)
+AC_SUBST(OBJECT_FMT)
+AC_SUBST(SHLIB_LDSTARTFILE)
+AC_SUBST(SHLIB_LDENDFILE)
 
 dnl Only one oddball right now (QNX), but this gives us flexibility
 dnl if any other platforms need to override this in the future.
@@ -1150,6 +1159,12 @@
     AM_PATH_GTK($GTK_VERSION,,
       AC_MSG_ERROR(Test for GTK failed.))
 
+case "$target" in
+i386-*-netbsd*)
+	GTK_LIBS=`echo $GTK_LIBS | sed -e 's/-Wl,//g'`
+	;;
+esac
+
 dnl ========================================================
 dnl =							   =
 dnl = --with-java-supplement				   =
@@ -1621,6 +1636,13 @@
     HOST_LIBIDL_LIBS=`${HOST_LIBIDL_CONFIG} --libs`
 fi
 
+case "$target" in
+i386-*-netbsd*)
+	GLIB_LIBS=`echo $GLIB_LIBS | sed -e 's/-Wl,//g'`
+	LIBIDL_LIBS=`echo $LIBIDL_LIBS | sed -e 's/-Wl,//g'`
+	;;
+esac
+
 dnl Checks for typedefs, structures, and compiler characteristics.
 dnl ========================================================
 AC_C_CONST
@@ -2760,6 +2782,7 @@
     *-*-solaris*) MOZ_MONOLITHIC_TOOLKIT= ;;
     *-openvms*)   MOZ_MONOLITHIC_TOOLKIT= ;;
     *-freebsd*)   MOZ_MONOLITHIC_TOOLKIT= ;;
+    *-netbsd*)    MOZ_MONOLITHIC_TOOLKIT= ;;
     *-*-aix*)     MOZ_MONOLITHIC_TOOLKIT= ;;
     *-*-osf*)     MOZ_MONOLITHIC_TOOLKIT= ;;
     *-hpux11.*)   MOZ_MONOLITHIC_TOOLKIT= ;;
