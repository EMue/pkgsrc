$NetBSD: patch-bc,v 1.4 1999/11/30 03:53:30 itohy Exp $

--- misc.c.nov6	Mon Nov 29 11:11:55 1999
+++ misc.c	Tue Nov 30 09:07:18 1999
@@ -44,7 +44,7 @@
  URL *Url=(URL*)malloc(sizeof(URL));
  char *copyurl,*mallocurl=malloc(strlen(url)+2);
  int i=0,n=0;
- char *colon,*slash,*at,*ques,*temppath,root[2];
+ char *colon,*slash,*escr,*at,*ques,*temppath,root[2];
 
  copyurl=mallocurl;
  strcpy(copyurl,url);
@@ -172,12 +172,17 @@
     strcpy(Url->host,copyurl);
    }
 
- for(i=0;Url->host[i] && Url->host[i]!=':';i++)
+ colon=strrchr(Url->host,':');
+ escr=strrchr(Url->host,']');
+ if (escr && colon < escr)
+     colon = strrchr(escr+1,':');
+
+ for(i=0;Url->host[i] && (i != colon - Url->host);i++)
     Url->host[i]=tolower(Url->host[i]);
 
- if(Url->host[i]==':')
-    if(atoi(&Url->host[i+1])==(Url->Protocol?Url->Protocol->defport:80))
-       Url->host[i]=0;
+ if(colon)
+    if(atoi(colon+1)==(Url->Protocol?Url->Protocol->defport:80))
+       *colon=0;
 
  if(!Url->local && IsLocalHost(Url->host,1) && Url->Protocol && Url->Protocol==&Protocols[0])
    {
