$NetBSD: patch-ai,v 1.3 2001/02/25 11:10:13 tron Exp $

--- src/server.c.orig	Fri Jan  9 18:16:22 1998
+++ src/server.c	Sun Feb 25 12:07:35 2001
@@ -2,19 +2,21 @@
  *  Copyright (C) 1995, 1996  Karl-Johan Johnsson.
  */
 
+#include <sys/types.h>
+#include <sys/socket.h>
+
 #include "global.h"
 #include "child.h"
 #include "codes.h"
 #include "connect.h"
 #include "file.h"
 #include "resource.h"
+#include "sysdeps.h"
 #include "server.h"
 #include "util.h"
 #include "widgets.h"
 #include "xutil.h"
 
-#include "sysdeps.h"
-
 struct SERVER {
     int		fd;
     char	*buffer;
@@ -128,30 +130,39 @@
  *  tell != 0   means tell about errors
  *  tell >  1   means say what you're doing
  */
-int server_open(SERVER *server, struct SERV_ADDR *addr, int tell)
+int server_open(SERVER *server, SERV_ADDR *addr, int tell)
 {
     long	tmp;
 
-    server_close(server);
-    server->fd = open_socket();
-    if (server->fd < 0) {
-	set_message("Error: Failed to create socket!", True);
-	return -1;
-    }
+    while (addr) {
+	server_close(server);
+	server->fd = open_socket(addr);
+	if (server->fd < 0) {
+	    set_message("Error: Failed to create socket!", True);
+	    return -1;
+	}
 
-    if (tell > 1)
-	set_message("Server contacted, waiting for response...", False);
+	if (tell > 1)
+	    set_message("Server contacted, waiting for response...", False);
 
-    tmp = connect_socket(server->fd, addr);
+	tmp = connect_socket(server->fd, addr);
 
-    if (tmp < 0 && would_block(server->fd, errno)) {
-	if (tell == 0)
-	    return 0; /* don't block */
-
-	tmp = 0;
-	do_wait(&server->fd, True, server->quit_func, server);
-	if (server->fd < 0)
-	    return -1;
+	if (tmp < 0 && would_block(server->fd, errno)) {
+	    if (tell == 0)
+		return 0; /* don't block */
+
+	    tmp = 0;
+	    do_wait(&server->fd, True, server->quit_func, server);
+	    if (server->fd >= 0)
+		break;
+	}
+
+	addr = next_addr(addr);
+    }
+
+    if (!addr) {
+	server_close(server);
+	return -1;
     }
 
     server->buffer[0] = '\0';
