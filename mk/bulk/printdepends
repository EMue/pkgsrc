#!/bin/sh
# $NetBSD: printdepends,v 1.4 2000/12/29 15:56:26 dmcmahill Exp $
#
# Print list of pkg dependencies suitable for tsort(1).
# Start in /usr/pkgsrc.
#
# (c) Copyright 2000 Hubert Feyrer <hubertf@netbsd.org>.
#     All rights reserved.
#

# /usr/pkgsrc
cwd=$PWD

# List of all pkgs, from pkgsrc/*/Makefile
 list=`grep '^[^#].*'SUBDIR */Makefile | sed 's,/Makefile.*= *,/,'`
#list=`grep '^[^#].*'SUBDIR ma*/Makefile | sed 's,/Makefile.*= *,/,'`
#list=x11/gnome
#list='x11/xteddy x11/xsnow'

mf=$cwd/.m.`hostname`.$$
# Makefile to print the DEPENDS' and BUILD_DEPENDS' directory parts
# bsd.pkg.mk is pulled in via the Makefile
cat >$mf <<EOF
bla:
	@echo \${DEPENDS:C/^[^:]*://:C/:.*$//} \${BUILD_DEPENDS:C/^[^:]*://:C/:.*$//}
.include "Makefile"
EOF


for pkgdir in $list
do
	cd $pkgdir

	l=`make -f - <$mf bla`	# XXX NOT -f $mf !
	if [ "$l" = "" ]; then
		# No dependencies
		echo "$pkgdir $pkgdir"
	else
		for reldir in $l
		do
			cd $reldir
			d=`dirname $PWD`
			absdir=`basename $d`/`basename $PWD`
			cd -
			echo "$absdir $pkgdir"
		done
	fi
	cd $cwd
done

rm -f $mf
