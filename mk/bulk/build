#!/bin/sh
# $NetBSD: build,v 1.6 2000/12/30 14:53:28 dmcmahill Exp $
#
# Do builk build
#
# (c) 2000 Hubert Feyrer, All Rights Reserved.
#

echo Bulk build started: `date`
echo ""

# Pull in ADMIN etc.:
if [ -f "$BULK_BUILD_CONF" ]; then
    . $BULK_BUILD_CONF
else
	conf=`dirname $0`/build.conf
	if [ -f "$conf" ]; then
		. $conf
	else
		echo "$0: Cannot find config file $conf, aborting."
		exit 1
	fi
fi

if [ "$http_proxy" != "" ]; then
	echo "Using HTTP proxy $http_proxy"
	export http_proxy
fi
if [ "$ftp_proxy" != "" ]; then
	echo "Using FTP proxy $ftp_proxy"
	export ftp_proxy
fi
echo ""

unset DISPLAY		# allow sane failure for gimp, xlispstat

cd ${USR_PKGSRC}

# extract the name of the files used for the build log and broken build log.
# these have defaults set by bsd.bulk-pkg.mk and may be overridden in /etc/mk.conf
BROKENF=`( cd $USR_PKGSRC/pkgtools/pkglint ; make show-var VARNAME=BROKENFILE )`;
export BROKENF
if [ "$BROKENF" = "" ]; then
	echo "Had problems determining the name of the .broken.files"
	exit 1
fi
BLDLOG=`( cd $USR_PKGSRC/pkgtools/pkglint ; make show-var VARNAME=BUILDLOG )`;
export BLDLOG
if [ "$BLDLOG" = "" ]; then
	echo "Had problems determining the name of the .make.files"
	exit 1
fi


if [ "$1" = "restart" ]; then
	echo Restarting - skipping pre-build script
else
	sh mk/bulk/pre-build	# make veryveryclean :)
fi

# Figure out optimal build order, and build
if [ "$1" != "restart" ]; then
	sh mk/bulk/printdepends | tsort | tee .l
fi
nice -n 20 make \
		SPECIFIC_PKGS=1 \
		GROUP_SPECIFIC_PKGS="`cat .l | tr '\012' ' '`" \
		bulk-package | sed 's/^/'`uname -p`'> /g'
rm .l

# Perl was wiped, reinstall it!
( cd lang/perl5-base ; make bulk-install )
perl mk/bulk/post-build | mail -s "pkgsrc/`uname -p` bulk build results `date +%F`" $ADMIN

# Done!
echo ""
echo Bulk build ended: `date`
